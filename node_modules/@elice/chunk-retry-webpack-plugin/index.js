"use strict";var e=require("webpack"),t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n={},a={},u=t&&t.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(a,"__esModule",{value:!0});const l=u(e),i="EliceChunkRetryWebpackPlugin";a.default=class{constructor(e={}){this.options={maxRetries:e.maxRetries||5,retryDelay:e.retryDelay||100}}apply(e){e.hooks.thisCompilation.tap(i,(e=>{const{mainTemplate:t,runtimeTemplate:r}=e,n=Number(this.options.maxRetries),a=Number.isInteger(n)&&n>0?n:1;t.hooks.localVars.tap({name:i,stage:1},(e=>{const t=r.basicFunction(["retryAttempt"],["if (retryAttempt < 1) {",l.default.Template.indent(["return 0;"]),"}",`return ${this.options.retryDelay} * retryAttempt;`]),n=l.default.Template.asString([`if (typeof ${l.default.RuntimeGlobals.require} !== "undefined") {`,l.default.Template.indent([`var prev_getScript = ${l.default.RuntimeGlobals.getChunkScriptFilename};`,`var prev_loadScript = ${l.default.RuntimeGlobals.ensureChunk};`,"var queryMap = {};","var countMap = {};",`var getRetryDelay = ${t};`,`${l.default.RuntimeGlobals.getChunkScriptFilename} = function (chunkId) {`,l.default.Template.indent(["var result = prev_getScript(chunkId);",'return result + (queryMap.hasOwnProperty(chunkId) ? "?" + queryMap[chunkId]  : "");']),"};",`${l.default.RuntimeGlobals.ensureChunk} = function (chunkId) {`,l.default.Template.indent(["var result = prev_loadScript(chunkId);","return result.catch(function (error) {",l.default.Template.indent([`var retries = countMap.hasOwnProperty(chunkId) ? countMap[chunkId] : ${a};`,"if (retries < 1) {",l.default.Template.indent(["var realSrc = prev_getScript(chunkId);",`error.message = "Loading chunk " + chunkId + " failed after ${a} retries.\\n(" + realSrc + ")";`,"error.request = realSrc;","throw error;"]),"}","return new Promise(function (resolve) {",l.default.Template.indent([`var retryAttempt = ${a} - retries + 1;`,"setTimeout(function () {",l.default.Template.indent(['var retryAttemptString = "&attempt=" + retryAttempt;','var cacheBust = "no-cache=" + Date.now() + retryAttemptString;',"queryMap[chunkId] = cacheBust;","countMap[chunkId] = retries - 1;",`resolve(${l.default.RuntimeGlobals.ensureChunk}(chunkId));`]),"}, getRetryDelay(retryAttempt));"]),"})"]),"});"]),"};"]),"}"]);return l.default.Template.asString([e,n])}))}))}};!function(e){var r=t&&t.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=a;Object.defineProperty(e,"default",{enumerable:!0,get:function(){return r(n).default}})}(n);var o=r(n);module.exports=o;
